version: '3.8'

services:
  # 1. The Anti-Gravity Frontend
  dashboard:
    build:
      context: ./event-horizon-ui
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_SITE_URL=https://db.vectabase.com
        - NEXT_PUBLIC_API_URL=http://localhost:8000
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000
      - NEXT_PUBLIC_SITE_URL=https://db.vectabase.com
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=postgres
      - DB_USER=postgres
      - DB_PASSWORD=your-super-secret-and-long-postgres-password
    depends_on:
      - orchestrator
      - postgres

  # 2. The PQC Auth Gateway (Simulated)
  # In production, this runs the Rust binary. Here we use a lightweight Alpine proxy mock or placeholder.
  pqc-gateway:
    image: nginx:alpine
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - postgrest
      - gotrue

  # 3. Core PostgreSQL Engine (Tenant A)
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: your-super-secret-and-long-postgres-password
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  # 4. PostgREST API
  postgrest:
    image: postgrest/postgrest
    ports:
      - "3001:3000"
    environment:
      PGRST_DB_URI: postgres://postgres:your-super-secret-and-long-postgres-password@postgres:5432/postgres
      PGRST_DB_SCHEMA: public
      PGRST_DB_ANON_ROLE: anon
      PGRST_JWT_SECRET: "reallyreallyreallyreallyverysafe"
    depends_on:
      - postgres

  # 5. GoTrue (Auth)
  gotrue:
    image: supabase/gotrue:v2.5.21
    ports:
      - "9999:9999"
    environment:
      GOTRUE_DB_DRIVER: postgres
      GOTRUE_DATABASE_URL: postgres://postgres:your-super-secret-and-long-postgres-password@postgres:5432/postgres
      GOTRUE_SITE_URL: http://localhost:3000
      GOTRUE_JWT_SECRET: "reallyreallyreallyreallyverysafe"
      GOTRUE_OPERATOR_TOKEN: super-secret-operator-token
      GOTRUE_EXTERNAL_GOOGLE_ENABLED: "true"
      GOTRUE_EXTERNAL_GOOGLE_CLIENT_ID: ${GOTRUE_EXTERNAL_GOOGLE_CLIENT_ID}
      GOTRUE_EXTERNAL_GOOGLE_SECRET: ${GOTRUE_EXTERNAL_GOOGLE_SECRET}
      API_EXTERNAL_URL: http://localhost:9999
    depends_on:
      - postgres

  # 6. EventHorizon Orchestrator (Mock)
  # This would be the Supervisor service in Go/Rust that spins up other containers
  orchestrator:
    image: alpine:latest
    command: tail -f /dev/null

volumes:
  pgdata:
